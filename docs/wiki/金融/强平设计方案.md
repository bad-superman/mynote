# 并发 & 幂等设计

## 2.1 账户级锁

```text
Redis Key: risk:sell:lock:{accountId}
TTL: 10s
```

---

## 2.2 幂等

```text
Key: liquidation:once:{accountId}:{timestamp}
```

---

## 2.3 Kafka Partition

```text
key = accountId
保证一个用户平仓信号在一个partition
```

# 三、表结构

### 3.1 强平任务表(risk\_force\_sell\_task)

| 字段  | 类型  |     |
| --- | --- | --- |
| uid | bigint |     |
| customer\_id | bigint |     |
| task\_id | char(32) |     |
| status | tinyint | 1执行中 2 完成 3取消 |
| rr  | float |     |
| rr\_version | int | rr计算结果版本，幂等 |
| extra |     |     |
| created\_at | datetime |     |
| updated\_at | datetime |     |

### 3.2 强平任务详情表（risk\_force\_sell\_task\_detail）

| 字段  |     |     |
| --- | --- | --- |
| task\_id |     |     |
| uid |     |     |
| customer\_id |     |     |
| symbol |     |     |
| price\_type |     | market市价 limit限价 |
| trade\_price |     |     |
| direction |     | 方向 1买入 2卖出 |
| side |     | long/short |
| trade\_num |     | 平仓数量 |
| status |     | 1 创建成功 2 执行成功 3 执行失败 4 取消 |
| reason |     | 执行失败，取消失败原因 |
| order\_id |     | 执行订单 |
| c\_order\_id |     | 自定义id，保持幂等，防止多次下单 |
| created\_at |     |     |
| updated\_at |     |     |